version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1
execution_time_limit:
  hours: 2
auto_cancel:
  running:
    when: "branch != 'main'"
blocks:
  - name: "resolve dependencies"
    dependencies: []
    task:
      env_vars:
        - name: MAVEN_OPTS
          value: "-Dmaven.repo.local=.m2"
      prologue:
        commands:
          - checkout
          - . vault-setup
          - chmod 700 ~/.m2/settings.xml
          - chmod 700 ~/.netrc
          - make docker-login-ci
          - export JAVA_VERSION=$(./scripts/get-java-version.sh)
          - echo "Using Java version: $JAVA_VERSION"
          - sem-version java $JAVA_VERSION
          - java -version
      jobs:
        - name: "dependencies"
          commands:
            - cache restore kafka-client-dependencies
            - ./mvnw dependency:go-offline clean install -DskipTests
      epilogue:
        on_pass:
          commands:
            - if [ "$SEMAPHORE_GIT_WORKING_BRANCH" = "main" ]; then cache delete kafka-client-dependencies; cache store kafka-client-dependencies .m2/; fi

  - name: "unit tests"
    dependencies: [ "resolve dependencies" ]
    task:
      prologue:
        commands:
          - checkout
          - export JAVA_VERSION=$(./scripts/get-java-version.sh)
          - echo "Using Java version: $JAVA_VERSION"
          - sem-version java $JAVA_VERSION
          - java -version
          - cache restore kafka-client-dependencies
      jobs:
        - name: "run unit tests"
          commands:
            - ./mvnw verify -Punit

  - name: "integration tests"
    dependencies: [ "resolve dependencies" ]
    task:
      prologue:
        commands:
          - checkout
          - export JAVA_VERSION=$(./scripts/get-java-version.sh)
          - echo "Using Java version: $JAVA_VERSION"
          - sem-version java $JAVA_VERSION
          - java -version
          - cache restore kafka-client-dependencies
      jobs:
        - name: "run integration tests"
          commands:
            - ./mvnw verify -Pintegration
      epilogue:
        always:
          commands:
            - test-results publish **/target/*-reports/*.xml